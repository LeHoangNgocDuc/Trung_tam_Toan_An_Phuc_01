<!DOCTYPE html>
<html lang="vi">

<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Hệ Thống Thi Trực Tuyến - An Phúc</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>

<script>
MathJax = {
  tex: { inlineMath: [['$', '$'], ['\\(', '\\)']] },
  svg: { fontCache: 'global' }
}
</script>
<script async id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

<style>
  img { max-width: 100%; height: auto; display: block; margin: 10px auto; }
  .hidden { display: none; }
  .loading {
    border: 4px solid #ccc;
    border-top: 4px solid #14da8d;
    border-radius: 50%;
    width: 25px; height: 25px;
    animation: spin 1s linear infinite;
  }
  @keyframes spin { 100% { transform: rotate(360deg); } }
</style>

</head>

<body class="bg-gray-100">

<div class="max-w-4xl mx-auto p-4">

  <h1 class="text-2xl font-bold text-center mb-6">TRUNG TÂM AN PHÚC</h1>

  <!-- NAVBAR -->
  <div class="flex justify-between mb-4">
    <button onclick="showExamList()" class="text-blue-600">Trang chủ</button>
    <button onclick="toggleAdmin()" class="text-blue-600">Admin</button>
  </div>

  <!-- ================= DANH SÁCH ĐỀ ================= -->
  <div id="exam-list" class="bg-white p-4 rounded shadow">
    <h2 class="text-xl font-semibold mb-3">Danh sách đề thi</h2>
    <div id="exam-items" class="space-y-3 text-lg"></div>
  </div>

  <!-- ================= ADMIN LOGIN ================= -->
  <div id="admin-panel" class="hidden bg-white p-4 mt-4 rounded shadow">
    <h2 class="text-xl font-semibold mb-2">Admin</h2>

    <input id="admin-pass" type="password" placeholder="Nhập mật khẩu"
      class="border p-2 rounded w-full mb-3">

    <button onclick="login()" class="bg-blue-500 text-white px-4 py-2 rounded">
      Đăng nhập
    </button>

    <div id="login-area" class="hidden mt-4">

      <h3 class="text-lg font-semibold mb-2">Upload Đề Thi</h3>

      <input id="exam-title" class="border p-2 w-full rounded mb-2"
        placeholder="Tên đề thi">

      <input id="exam-duration" class="border p-2 w-full rounded mb-2"
        placeholder="Thời gian (phút)" type="number">

      <input id="file-word" type="file" class="mb-3">

      <button onclick="processFile()"
        class="bg-green-600 text-white px-4 py-2 rounded w-full">
        Xử lý & Upload
      </button>

      <div id="status" class="mt-2 text-blue-600 font-semibold"></div>

    </div>
  </div>

  <!-- PREVIEW DEBUG -->
  <div id="preview-box"
    class="hidden bg-white p-4 mt-4 rounded shadow text-sm whitespace-pre-wrap">
  </div>

  <!-- ================= KHU VỰC LÀM BÀI ================= -->
  <div id="quiz-area" class="hidden mt-4 bg-white p-4 rounded shadow"></div>

  <div id="submit-btn" class="hidden mt-4 text-center">
    <button onclick="submitTest()"
      class="bg-green-600 text-white px-6 py-2 rounded-full">
      Nộp bài
    </button>
  </div>

  <!-- ================= KẾT QUẢ ================= -->
  <div id="result-view" class="hidden bg-white p-4 mt-4 rounded shadow">
    <h2 class="text-xl font-bold">Kết Quả</h2>
    <div id="score-display" class="text-5xl font-extrabold my-4 text-blue-600"></div>
    <div id="detail-review" class="space-y-4 text-left"></div>
  </div>

</div>
<script>

/* ==================== CONFIG ==================== */
const API =
 "https://script.google.com/macros/s/AKfycbzQrorHyzjPXMJXhMSRMjZEpJJm8G7FIDTqKpL1meLX6K2cyTvnMZW1qgOKt3wsVt64/exec";

let currExamId = "";
let questions = [];

/* ==================== ADMIN ==================== */

function toggleAdmin(){
  document.getElementById('admin-panel').classList.toggle('hidden');
}

function login(){
  const pw = document.getElementById("admin-pass").value;
  if(pw === "anphuc"){
    document.getElementById("login-area").classList.remove("hidden");
    document.getElementById("upload-area")?.classList.remove("hidden");
  } else {
    alert("Sai mật khẩu!");
  }
}

/* =============================================================
   ===============   UPLOAD + PARSE WORD   =====================
   ============================================================= */

function processFile(){
  const file = document.getElementById("file-word").files[0];
  if(!file) return alert("Chưa chọn file Word!");

  document.getElementById("status").innerText = "Đang xử lý file Word...";

  let reader = new FileReader();
  reader.onload = e=>{
    mammoth.convertToHtml({arrayBuffer: e.target.result}).then(r=>{

      // DEBUG preview
      document.getElementById("preview-box").classList.remove("hidden");
      document.getElementById("preview-box").innerText = r.value;

      // PARSE đề
      questions = parseWord(r.value);

      alert("Parser đọc được: " + questions.length + " câu hỏi.");

      // Upload
      uploadData(questions);
    });
  };
  reader.readAsArrayBuffer(file);
}

/* =============================================================
   ======================= PARSER WORD ==========================
   ============================================================= */

function parseWord(html){
  const lines = html
      .replace(/<[^>]+>/g, '')     // bỏ toàn bộ thẻ html
      .replace(/&nbsp;/g, ' ')
      .split(/\n|\r/)
      .map(s=>s.trim())
      .filter(s=>s.length > 0);

  let arr = [];
  let part = 1;

  for(let line of lines){

    // Chuyển sang phần II
    if(line.toUpperCase().includes("PHẦN II")) part = 2;

    // Chuyển sang phần III
    if(line.toUpperCase().includes("PHẦN III")) part = 3;

    //------------------------------------------------
    // PART 1: TRẮC NGHIỆM 4 LỰA CHỌN
    //------------------------------------------------
    if(part === 1){

      // Dạng 1: "Câu ... A. ... B. ... C. ... D. ..."
      let m = line.match(/^Câu\s*\d+[:.)]?\s*(.*)/i);
      if(m){
        let content = m[1];

        let optA = "", optB = "", optC = "", optD = "";

        const pattA = /(A\.|A\))\s*(.*?)(?=B\.|B\))/i;
        const pattB = /(B\.|B\))\s*(.*?)(?=C\.|C\))/i;
        const pattC = /(C\.|C\))\s*(.*?)(?=D\.|D\))/i;
        const pattD = /(D\.|D\))\s*(.*)$/i;

        optA = (content.match(pattA)?.[2] || "").trim();
        optB = (content.match(pattB)?.[2] || "").trim();
        optC = (content.match(pattC)?.[2] || "").trim();
        optD = (content.match(pattD)?.[2] || "").trim();

        arr.push({
          type: "choice",
          question: content.replace(/A\.|A\).*/i, "").trim(),
          optA, optB, optC, optD,
          correct: "",
          solution: "",
          tfA: "", tfB: "", tfC: "", tfD: "",
          shortAns: ""
        });
      }
    }

    //------------------------------------------------
    // PART 2: ĐÚNG SAI
    //------------------------------------------------
    if(part === 2){
      if(line.startsWith("_")){   // gạch chân = đúng
        arr.push({
          type: "truefalse",
          question: line.replace(/^_+/, '').trim(),
          optA: "", optB: "", optC: "", optD: "",
          correct: "ĐÚNG",
          solution: "",
          tfA: "ĐÚNG",
          tfB: "SAI",
          tfC: "", tfD: "",
          shortAns: ""
        });
      }
      else {
        arr.push({
          type: "truefalse",
          question: line.trim(),
          optA: "", optB: "", optC: "", optD: "",
          correct: "SAI",
          solution: "",
          tfA: "ĐÚNG",
          tfB: "SAI",
          tfC: "", tfD: "",
          shortAns: ""
        });
      }
    }

    //------------------------------------------------
    // PART 3: TỰ LUẬN / TRẢ LỜI NGẮN
    //------------------------------------------------
    if(part === 3){
      arr.push({
        type: "short",
        question: line.trim(),
        optA: "", optB: "", optC: "", optD: "",
        correct: "",
        solution: "",
        tfA: "", tfB: "", tfC: "", tfD: "",
        shortAns: ""
      });
    }
  }

  return arr;
}

/* =============================================================
   ================== UPLOAD LÊN GOOGLE SHEET ==================
   ============================================================= */

async function uploadData(list){
  const examTitle = document.getElementById("exam-title").value.trim();
  const examDuration = document.getElementById("exam-duration").value.trim();

  if(!examTitle || !examDuration){
    alert("Nhập tên đề + thời gian!");
    return;
  }

  document.getElementById("status").innerText = "Đang upload...";

  let payload = {
    action: "upload",
    title: examTitle,
    duration: examDuration,
    questions: list
  };

  const res = await fetch(API, {
    method: "POST",
    body: JSON.stringify(payload)
  });

  const js = await res.json();

  if(js.status === "success"){
    alert("Upload thành công!");
    loadExams();
  } else {
    alert("Lỗi upload: " + js.message);
  }

  document.getElementById("status").innerText = "";
}

</script>
<script>

/* =============================================================
   ===================== LOAD DANH SÁCH ĐỀ =====================
   ============================================================= */

async function loadExams(){
  const res = await fetch(API + "?action=getExams");
  const js = await res.json();

  let box = document.getElementById("exam-items");
  box.innerHTML = "";

  js.data.forEach(ex=>{
    let div = document.createElement("div");
    div.className = "p-3 border rounded bg-gray-50 cursor-pointer";
    div.innerHTML = `
      <b>${ex.title}</b> - ${ex.duration} phút
    `;
    div.onclick = ()=>startExam(ex.id, ex.title, ex.duration);
    box.appendChild(div);
  });
}

/* =============================================================
   ====================== BẮT ĐẦU LÀM BÀI =======================
   ============================================================= */

async function startExam(id, title, duration){
  currExamId = id;

  const res = await fetch(API + "?action=getQuestions&exam_id=" + id);
  const js = await res.json();
  questions = js.data;

  document.getElementById("exam-list").classList.add("hidden");
  document.getElementById("quiz-area").classList.remove("hidden");
  document.getElementById("submit-btn").classList.remove("hidden");

  renderQuestions(questions);
}

/* =============================================================
   ================= RENDER CÂU HỎI TRONG BÀI ===================
   ============================================================= */

function renderQuestions(list){
  let html = "";

  list.forEach((q, i)=>{

    html += `<div class="p-4 border rounded mb-4">`;
    html += `<div class="font-semibold mb-2">Câu ${i+1}. ${q.question}</div>`;

    if(q.type === "choice"){
      html += choiceRender(q, i);
    }
    if(q.type === "truefalse"){
      html += tfRender(q, i);
    }
    if(q.type === "short"){
      html += shortRender(q, i);
    }

    html += `</div>`;
  });

  document.getElementById("quiz-area").innerHTML = html;
  MathJax.typeset();
}

function choiceRender(q, idx){
  return `
    <label class="block"><input type="radio" name="q${idx}" value="A"> A. ${q.optA}</label>
    <label class="block"><input type="radio" name="q${idx}" value="B"> B. ${q.optB}</label>
    <label class="block"><input type="radio" name="q${idx}" value="C"> C. ${q.optC}</label>
    <label class="block"><input type="radio" name="q${idx}" value="D"> D. ${q.optD}</label>
  `;
}

function tfRender(q, idx){
  return `
    <label class="block"><input type="radio" name="q${idx}" value="ĐÚNG"> Đúng</label>
    <label class="block"><input type="radio" name="q${idx}" value="SAI"> Sai</label>
  `;
}

function shortRender(q, idx){
  return `
    <input
      type="text"
      name="q${idx}"
      class="border p-2 rounded w-full"
      placeholder="Nhập câu trả lời..."
    >
  `;
}

/* =============================================================
   ========================= NỘP BÀI ============================
   ============================================================= */

function submitTest(){
  if(!confirm("Bạn chắc chắn nộp bài chứ?")) return;

  let score = 0;
  let detail = [];

  questions.forEach((q, i)=>{
    let ans = document.querySelector(`input[name="q${i}"]:checked`)?.value
           || document.querySelector(`input[name="q${i}"]`)?.value
           || "";

    let isCorrect = false;

    if(q.type === "choice"){
      if(ans === q.correct) isCorrect = true;
    }

    if(q.type === "truefalse"){
      if(ans === q.correct) isCorrect = true;
    }

    if(q.type === "short"){
      if(ans.trim().toLowerCase() === q.shortAns.trim().toLowerCase()){
        isCorrect = true;
      }
    }

    if(isCorrect) score++;

    detail.push({
      question: q.question,
      your: ans,
      correct: q.correct || q.shortAns
    });
  });

  showResult(score, detail);
}

/* =============================================================
   ====================== HIỂN THỊ KẾT QUẢ =====================
   ============================================================= */

function showResult(score, detail){

  document.getElementById("quiz-area").classList.add("hidden");
  document.getElementById("submit-btn").classList.add("hidden");
  document.getElementById("result-view").classList.remove("hidden");

  document.getElementById("score-display").innerText = score + "/" + questions.length;

  let html = "";
  detail.forEach((d, i)=>{
    html += `
      <div class="p-3 border rounded">
        <b>Câu ${i+1}</b><br>
        <i>${d.question}</i><br>
        <span class="text-blue-600">Bạn chọn: ${d.your}</span><br>
        <span class="text-green-700">Đáp án: ${d.correct}</span>
      </div>
    `;
  });

  document.getElementById("detail-review").innerHTML = html;
}

/* =============================================================
   ======================== KHỞI TẠO ============================
   ============================================================= */
loadExams();

</script>

</body>
</html>
