<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªá Th·ªëng Thi Tr·ª±c Tuy·∫øn - An Ph√∫c</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script>
        MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']], // Nh·∫≠n di·ªán c√¥ng th·ª©c trong d·∫•u $...$
                displayMath: [['$$', '$$'], ['\\[', '\\]']]
            },
            svg: {fontCache: 'global'}
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <style>
        /* CSS t√πy ch·ªânh cho n·ªôi dung ƒë·ªÅ thi */
        .latex-content img { display: inline-block; max-width: 100%; margin-top: 10px; margin-bottom: 10px; }
        .hidden { display: none; }
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-100 min-h-screen font-sans">

    <header class="bg-blue-700 text-white p-4 shadow-md sticky top-0 z-50">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-xl font-bold uppercase">Thi Tr·ª±c Tuy·∫øn An Ph√∫c</h1>
            <div>
                <button onclick="showSection('home')" class="px-3 py-1 hover:bg-blue-800 rounded transition">Trang ch·ªß</button>
                <button onclick="toggleAdminPanel()" class="px-3 py-1 hover:bg-blue-800 rounded transition">Admin</button>
            </div>
        </div>
    </header>

    <div class="container mx-auto p-4 max-w-5xl">
        
        <div id="admin-section" class="hidden bg-white p-6 rounded-lg shadow-lg mb-6 border-t-4 border-orange-500">
            <h2 class="text-lg font-bold mb-4 text-orange-600">Khu v·ª±c Qu·∫£n tr·ªã vi√™n</h2>
            
            <div id="login-form" class="flex items-center">
                <input type="password" id="admin-pass" placeholder="Nh·∫≠p m·∫≠t kh·∫©u qu·∫£n tr·ªã" class="border p-2 rounded mr-2 w-64 focus:outline-none focus:ring-2 focus:ring-orange-400">
                <button onclick="checkAdmin()" class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded transition">ƒêƒÉng nh·∫≠p</button>
            </div>

            <div id="upload-form" class="hidden">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block mb-2 font-medium">T√™n ƒë·ªÅ thi:</label>
                        <input type="text" id="exam-title" class="border p-2 w-full rounded focus:outline-none focus:ring-2 focus:ring-blue-300" placeholder="VD: ƒê·ªÅ thi th·ª≠ To√°n 12...">
                    </div>
                    <div>
                        <label class="block mb-2 font-medium">Th·ªùi gian l√†m b√†i (ph√∫t):</label>
                        <input type="number" id="exam-duration" value="90" class="border p-2 w-full rounded focus:outline-none focus:ring-2 focus:ring-blue-300">
                    </div>
                </div>
                <div class="mb-4">
                    <label class="block mb-2 font-medium">Ch·ªçn file ƒë·ªÅ (.docx):</label>
                    <input type="file" id="file-input" accept=".docx" class="border p-2 w-full bg-gray-50 rounded">
                    <p class="text-xs text-gray-500 mt-1">*File word c·∫ßn ƒë√∫ng ƒë·ªãnh d·∫°ng m·∫´u (C√¢u 1., A., B., C., D., L·ªùi gi·∫£i, h√¨nh ·∫£nh...)</p>
                </div>
                <button onclick="uploadExam()" id="btn-upload" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded font-bold shadow transition w-full md:w-auto">
                    Upload & T·∫°o ƒë·ªÅ
                </button>
                <p id="upload-status" class="mt-3 text-sm font-semibold text-blue-600"></p>
            </div>
        </div>

        <div id="home-section">
            <div class="flex justify-between items-end mb-6 border-b pb-2">
                <h2 class="text-2xl font-bold text-gray-800">Danh s√°ch ƒë·ªÅ thi hi·ªán c√≥</h2>
                <button onclick="fetchExams()" class="text-blue-600 text-sm underline">L√†m m·ªõi danh s√°ch</button>
            </div>
            
            <div id="exam-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <div class="text-center col-span-3 py-10">
                    <div class="loading-spinner"></div>
                    <p class="mt-2 text-gray-500">ƒêang t·∫£i d·ªØ li·ªáu...</p>
                </div>
            </div>
        </div>

        <div id="exam-section" class="hidden">
            <div class="bg-white p-4 rounded shadow-md sticky top-0 z-40 flex justify-between items-center border-b-2 border-blue-500">
                <div>
                    <h2 id="current-exam-title" class="text-lg font-bold text-blue-800 line-clamp-1"></h2>
                    <p class="text-sm text-gray-600">Th√≠ sinh: <span id="student-info-display" class="font-semibold"></span></p>
                </div>
                <div class="text-right">
                    <p class="text-xs text-gray-500">Th·ªùi gian c√≤n l·∫°i</p>
                    <div class="text-red-600 font-bold text-2xl font-mono" id="timer">00:00</div>
                </div>
            </div>

            <div id="student-form" class="bg-white p-8 rounded-lg shadow-lg max-w-md mx-auto mt-10">
                <h3 class="text-xl font-bold mb-6 text-center text-gray-800">Th√¥ng tin th√≠ sinh</h3>
                <div class="space-y-4">
                    <input type="text" id="s-name" placeholder="H·ªç v√† t√™n c·ªßa b·∫°n" class="border p-3 w-full rounded focus:ring-2 focus:ring-blue-400 outline-none">
                    <input type="text" id="s-class" placeholder="L·ªõp / Tr∆∞·ªùng" class="border p-3 w-full rounded focus:ring-2 focus:ring-blue-400 outline-none">
                    <button onclick="startExam()" class="bg-blue-600 hover:bg-blue-700 text-white w-full py-3 rounded font-bold text-lg transition shadow-lg transform hover:scale-105">
                        B·∫ÆT ƒê·∫¶U L√ÄM B√ÄI
                    </button>
                </div>
            </div>

            <div id="questions-container" class="hidden space-y-8 mt-6">
                </div>

            <div id="submit-area" class="hidden mt-10 mb-20 text-center">
                <button onclick="confirmSubmit()" class="bg-green-600 hover:bg-green-700 text-white px-10 py-4 rounded-full text-xl font-bold shadow-xl transition transform hover:scale-105">
                    N·ªòP B√ÄI THI
                </button>
            </div>
        </div>

        <div id="result-section" class="hidden bg-white p-6 rounded-lg shadow-lg">
            <h2 class="text-3xl font-bold text-center mb-2 text-gray-800">K·∫øt Qu·∫£ L√†m B√†i</h2>
            <div class="flex justify-center items-center flex-col mb-8">
                <div class="text-6xl font-extrabold text-blue-600" id="final-score">0.0</div>
                <p class="text-gray-500 mt-2">ƒêi·ªÉm s·ªë c·ªßa b·∫°n</p>
            </div>
            
            <div class="border-t pt-6">
                <h3 class="text-xl font-bold mb-4 text-gray-700">Chi ti·∫øt l·ªùi gi·∫£i:</h3>
                <div id="review-container" class="space-y-8">
                    </div>
            </div>
            
            <div class="text-center mt-10">
                <button onclick="location.reload()" class="bg-gray-600 hover:bg-gray-700 text-white px-6 py-2 rounded transition">
                    Quay l·∫°i m√†n h√¨nh ch√≠nh
                </button>
            </div>
        </div>

    </div>

    <script>
        // --- C·∫§U H√åNH ---
        // Link Web App Google Apps Script c·ªßa b·∫°n
        const API_URL = "https://script.google.com/macros/s/AKfycbzPz53x0qzJLdUDMiWkBrgc7wFAeeV43MKgzoDYktkR1qS8WhKDGv5YJ03XwTefjcYL/exec"; 

        // Bi·∫øn to√†n c·ª•c
        let allQuestions = [];
        let currentExamId = "";
        let currentExamTitle = "";
        let timerInterval;
        let examDurationSeconds = 0;

        // --- C√ÅC H√ÄM CH√çNH ---
        
        // 1. L·∫•y danh s√°ch ƒë·ªÅ thi t·ª´ Google Sheet
        async function fetchExams() {
            const container = document.getElementById('exam-list');
            container.innerHTML = '<div class="text-center col-span-3"><div class="loading-spinner"></div></div>';
            
            try {
                const res = await fetch(API_URL + "?action=getExams");
                const json = await res.json();
                
                container.innerHTML = "";
                
                if(!json.data || json.data.length === 0) {
                    container.innerHTML = "<p class='text-center col-span-3 text-gray-500'>Hi·ªán ch∆∞a c√≥ ƒë·ªÅ thi n√†o.</p>";
                    return;
                }

                json.data.forEach(exam => {
                    // Chuy·ªÉn ƒë·ªïi timestamp th√†nh ng√†y th√°ng
                    const dateObj = new Date(exam.created_at);
                    const dateStr = dateObj.toLocaleDateString('vi-VN');

                    const div = document.createElement('div');
                    div.className = "bg-white p-6 rounded-lg shadow hover:shadow-xl transition border border-gray-100 flex flex-col justify-between h-full";
                    div.innerHTML = `
                        <div>
                            <span class="bg-blue-100 text-blue-800 text-xs font-semibold px-2.5 py-0.5 rounded dark:bg-blue-200 dark:text-blue-800">M·ªõi</span>
                            <h3 class="text-lg font-bold mb-2 mt-2 text-gray-800 leading-tight">${exam.title}</h3>
                            <div class="text-sm text-gray-600 space-y-1 mb-4">
                                <p><span class="font-semibold">‚è± Th·ªùi gian:</span> ${exam.duration} ph√∫t</p>
                                <p><span class="font-semibold">üìÖ Ng√†y t·∫°o:</span> ${dateStr}</p>
                            </div>
                        </div>
                        <button onclick="prepareExam('${exam.id}', '${exam.title}', ${exam.duration})" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded w-full font-semibold transition">
                            V√†o thi ngay
                        </button>
                    `;
                    container.appendChild(div);
                });
            } catch (e) {
                console.error(e);
                container.innerHTML = "<p class='text-red-500 text-center col-span-3'>L·ªói t·∫£i d·ªØ li·ªáu. Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi internet.</p>";
            }
        }

        // 2. Chu·∫©n b·ªã v√†o thi (Hi·ªÉn th·ªã form nh·∫≠p t√™n)
        function prepareExam(id, title, duration) {
            currentExamId = id;
            currentExamTitle = title;
            examDurationSeconds = duration * 60;

            // Chuy·ªÉn ƒë·ªïi giao di·ªán
            document.getElementById('home-section').classList.add('hidden');
            document.getElementById('exam-section').classList.remove('hidden');
            document.getElementById('admin-section').classList.add('hidden'); // ·∫®n admin n·∫øu ƒëang m·ªü
            
            // Reset c√°c v√πng
            document.getElementById('current-exam-title').innerText = title;
            document.getElementById('student-form').classList.remove('hidden');
            document.getElementById('questions-container').classList.add('hidden');
            document.getElementById('submit-area').classList.add('hidden');
            document.getElementById('timer').innerText = formatTime(examDurationSeconds);
        }

        // 3. B·∫Øt ƒë·∫ßu l√†m b√†i (Load c√¢u h·ªèi)
        async function startExam() {
            const name = document.getElementById('s-name').value.trim();
            const className = document.getElementById('s-class').value.trim();
            
            if(!name || !className) {
                alert("Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß H·ªç t√™n v√† L·ªõp!");
                return;
            }

            document.getElementById('student-info-display').innerText = `${name} - ${className}`;
            document.getElementById('student-form').classList.add('hidden');
            
            const qContainer = document.getElementById('questions-container');
            qContainer.innerHTML = '<div class="text-center mt-10"><div class="loading-spinner"></div><p class="mt-4">ƒêang t·∫£i ƒë·ªÅ thi...</p></div>';
            qContainer.classList.remove('hidden');

            try {
                // G·ªçi API l·∫•y c√¢u h·ªèi
                const res = await fetch(API_URL + `?action=getQuestions&examId=${currentExamId}`);
                const json = await res.json();
                allQuestions = json.data;
                
                renderQuestions(allQuestions);
                document.getElementById('submit-area').classList.remove('hidden');

                // B·∫Øt ƒë·∫ßu ƒë·∫øm ng∆∞·ª£c
                startTimer(examDurationSeconds);
            } catch (e) {
                alert("Kh√¥ng th·ªÉ t·∫£i ƒë·ªÅ thi. Vui l√≤ng th·ª≠ l·∫°i!");
                location.reload();
            }
        }

        // 4. Render c√¢u h·ªèi ra m√†n h√¨nh
        function renderQuestions(questions) {
            const container = document.getElementById('questions-container');
            container.innerHTML = "";
            
            questions.forEach((q, index) => {
                const qNum = index + 1;
                let html = `
                <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200 latex-content" id="q-card-${index}">
                    <div class="flex items-start">
                        <span class="bg-blue-600 text-white font-bold py-1 px-3 rounded mr-3 text-sm flex-shrink-0">C√¢u ${qNum}</span>
                        <div class="text-gray-800 text-lg w-full">
                            ${formatText(q.question)}
                        </div>
                    </div>`;
                
                // N·∫øu c√≥ ·∫£nh c√¢u h·ªèi
                if(q.image) {
                    html += `<div class="mt-3 flex justify-center"><img src="${q.image}" class="rounded border shadow-sm max-h-96"></div>`;
                }

                // X·ª≠ l√Ω hi·ªÉn th·ªã ƒë√°p √°n theo lo·∫°i c√¢u h·ªèi
                html += `<div class="mt-4 ml-0 md:ml-12">`;

                if(q.type === '1_choice') { // Tr·∫Øc nghi·ªám 4 ƒë√°p √°n
                    ['A', 'B', 'C', 'D'].forEach(opt => {
                        const content = q.options[opt];
                        if(content) {
                            html += `
                            <label class="flex items-start p-3 border rounded mb-2 hover:bg-blue-50 cursor-pointer transition">
                                <input type="radio" name="q${index}" value="${opt}" class="mt-1 mr-3 w-5 h-5 text-blue-600">
                                <span class="font-medium mr-2">${opt}.</span>
                                <span>${formatText(content)}</span>
                            </label>`;
                        }
                    });
                } else if (q.type === 'true_false') { // ƒê√∫ng Sai
                    html += `
                        <div class="mb-3 italic text-gray-600 text-sm bg-gray-50 p-2 rounded">
                            M·ªánh ƒë·ªÅ cho s·∫µn: <br>
                            ${q.sub_questions ? formatText(q.sub_questions) : ''}
                        </div>
                        <div class="grid grid-cols-1 gap-2">
                           ${renderTrueFalseInput(index, 'a')}
                           ${renderTrueFalseInput(index, 'b')}
                           ${renderTrueFalseInput(index, 'c')}
                           ${renderTrueFalseInput(index, 'd')}
                        </div>
                        <p class="text-xs text-gray-400 mt-2">*ƒêi·ªÅn ƒê (ƒê√∫ng) ho·∫∑c S (Sai)</p>
                    `;
                } else if (q.type === 'short') { // Tr·∫£ l·ªùi ng·∫Øn
                    html += `
                        <label class="block mb-2 font-medium text-gray-700">Nh·∫≠p ƒë√°p √°n c·ªßa b·∫°n:</label>
                        <input type="text" name="q${index}" class="border border-gray-300 p-3 rounded w-full focus:outline-none focus:border-blue-500" placeholder="V√≠ d·ª•: 12.5 ho·∫∑c -5...">
                    `;
                }

                html += `</div></div>`; // End answers div & card div
                container.innerHTML += html;
            });
            
            // K√≠ch ho·∫°t MathJax ƒë·ªÉ render c√¥ng th·ª©c
            MathJax.typesetPromise();
        }

        function renderTrueFalseInput(qIndex, subId) {
            return `
            <div class="flex items-center space-x-3">
                <span class="font-bold w-4 text-center">${subId})</span>
                <input type="text" name="q${qIndex}_${subId}" class="border p-2 rounded w-20 text-center uppercase font-bold focus:ring-blue-500 focus:border-blue-500" placeholder="ƒê/S" maxlength="1">
            </div>`;
        }

        function formatText(text) {
            if(!text) return "";
            // Thay th·∫ø xu·ªëng d√≤ng b·∫±ng <br> ƒë·ªÉ hi·ªÉn th·ªã ƒë√∫ng HTML
            return text.replace(/\n/g, '<br>');
        }

        // 5. ƒê·ªìng h·ªì ƒë·∫øm ng∆∞·ª£c
        function startTimer(duration) {
            let timer = duration;
            const display = document.getElementById('timer');
            
            timerInterval = setInterval(function () {
                let minutes = parseInt(timer / 60, 10);
                let seconds = parseInt(timer % 60, 10);

                minutes = minutes < 10 ? "0" + minutes : minutes;
                seconds = seconds < 10 ? "0" + seconds : seconds;

                display.textContent = minutes + ":" + seconds;

                if (--timer < 0) {
                    clearInterval(timerInterval);
                    alert("ƒê√£ h·∫øt th·ªùi gian l√†m b√†i! H·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông n·ªôp b√†i.");
                    submitExam();
                }
            }, 1000);
        }

        function formatTime(seconds) {
            let m = Math.floor(seconds / 60);
            let s = seconds % 60;
            return (m < 10 ? "0"+m : m) + ":" + (s < 10 ? "0"+s : s);
        }

        // 6. N·ªôp b√†i
        function confirmSubmit() {
            if(confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën n·ªôp b√†i kh√¥ng?")) {
                submitExam();
            }
        }

        async function submitExam() {
            clearInterval(timerInterval);
            
            // Hi·ªáu ·ª©ng ƒëang x·ª≠ l√Ω
            const btnSubmit = document.querySelector('#submit-area button');
            if(btnSubmit) {
                btnSubmit.innerText = "ƒêang ch·∫•m ƒëi·ªÉm...";
                btnSubmit.disabled = true;
                btnSubmit.classList.add('opacity-50');
            }

            // T√≠nh ƒëi·ªÉm logic (Client side - mang t√≠nh tham kh·∫£o nhanh)
            let totalScore = 0;
            let detail = [];
            // Quy ∆∞·ªõc ƒëi·ªÉm: Tr·∫Øc nghi·ªám 0.2, ƒêi·ªÅn khuy·∫øt 0.2. (C√≥ th·ªÉ s·ª≠a logic n√†y)
            // ƒê√∫ng sai th√¨ ph·ª©c t·∫°p h∆°n, ·ªü ƒë√¢y t·∫°m t√≠nh ƒë∆°n gi·∫£n.

            allQuestions.forEach((q, index) => {
                let isCorrect = false;
                let userAnswer = "";
                let scoreEarned = 0;

                if(q.type === '1_choice') {
                    const selected = document.querySelector(`input[name="q${index}"]:checked`);
                    userAnswer = selected ? selected.value : "";
                    if(userAnswer === q.correct) {
                        scoreEarned = 0.2; // ƒêi·ªÉm m·ªói c√¢u
                        isCorrect = true;
                    }
                } else if (q.type === 'short') {
                    userAnswer = document.querySelector(`input[name="q${index}"]`).value.trim();
                    // So s√°nh t∆∞∆°ng ƒë·ªëi (b·ªè kho·∫£ng tr·∫Øng)
                    if(userAnswer.toLowerCase() === q.correct.toLowerCase()) {
                        scoreEarned = 0.2;
                        isCorrect = true;
                    }
                } else if (q.type === 'true_false') {
                    // Logic ƒë√∫ng sai: ·ªû ƒë√¢y t·∫°m th·ªùi gom h·∫øt input l·∫°i ƒë·ªÉ hi·ªÉn th·ªã, ch∆∞a ch·∫•m ƒëi·ªÉm chi ti·∫øt t·ª´ng √Ω
                    let subAns = [];
                    ['a','b','c','d'].forEach(id => {
                        let val = document.querySelector(`input[name="q${index}_${id}"]`).value.trim().toUpperCase();
                        subAns.push(`${id}:${val}`);
                    });
                    userAnswer = subAns.join(", ");
                    // Logic ch·∫•m ƒëi·ªÉm ƒë√∫ng sai kh√° ph·ª©c t·∫°p (ƒë√∫ng 1 √Ω, 2 √Ω...), t·∫°m th·ªùi ƒë·ªÉ 0 ƒëi·ªÉm hi·ªÉn th·ªã
                }
                
                totalScore += scoreEarned;

                detail.push({
                    qIndex: index,
                    question: q.question,
                    type: q.type,
                    user: userAnswer,
                    correct: q.correct, // ƒê√°p √°n ƒë√∫ng t·ª´ data
                    isCorrect: isCorrect,
                    solution: q.solution,
                    image: q.image
                });
            });

            // G·ª≠i d·ªØ li·ªáu v·ªÅ Sheet
            const studentData = {
                student_name: document.getElementById('s-name').value,
                class_name: document.getElementById('s-class').value,
                exam_title: currentExamTitle,
                score: totalScore.toFixed(2),
                detail: detail
            };

            try {
                // G·ª≠i request POST (no-cors ƒë·ªÉ tr√°nh l·ªói tr√¨nh duy·ªát ch·∫∑n, d√π kh√¥ng nh·∫≠n ƒë∆∞·ª£c response JSON tr·ª±c ti·∫øp nh∆∞ng GAS v·∫´n ch·∫°y)
                await fetch(API_URL + "?action=submitExam", {
                    method: 'POST',
                    mode: 'no-cors', 
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(studentData)
                });
                
                // Hi·ªÉn th·ªã k·∫øt qu·∫£ (do mode no-cors kh√¥ng ƒë·ªçc ƒë∆∞·ª£c response, ta t·ª± hi·ªÉn th·ªã d·ª±a tr√™n t√≠nh to√°n client)
                showResult(totalScore.toFixed(2), detail);
            } catch(e) {
                console.error(e);
                alert("C√≥ l·ªói khi g·ª≠i b√†i, nh∆∞ng k·∫øt qu·∫£ ƒë√£ ƒë∆∞·ª£c hi·ªÉn th·ªã b√™n d∆∞·ªõi.");
                showResult(totalScore.toFixed(2), detail);
            }
        }

        // 7. Hi·ªÉn th·ªã k·∫øt qu·∫£ chi ti·∫øt
        function showResult(score, detail) {
            document.getElementById('exam-section').classList.add('hidden');
            document.getElementById('result-section').classList.remove('hidden');
            
            // Animation ƒëi·ªÉm s·ªë
            const scoreEl = document.getElementById('final-score');
            let current = 0;
            const target = parseFloat(score);
            const interval = setInterval(() => {
                current += 0.1;
                if(current >= target) {
                    current = target;
                    clearInterval(interval);
                }
                scoreEl.innerText = current.toFixed(2);
            }, 30);

            const container = document.getElementById('review-container');
            container.innerHTML = "";

            detail.forEach((item, i) => {
                // X√°c ƒë·ªãnh m√†u s·∫Øc d·ª±a tr√™n ƒë√∫ng sai
                let borderColor = item.isCorrect ? "border-green-500" : "border-red-500";
                let badge = item.isCorrect 
                    ? `<span class="bg-green-100 text-green-800 text-xs font-bold px-2 py-1 rounded">ƒê√öNG</span>` 
                    : `<span class="bg-red-100 text-red-800 text-xs font-bold px-2 py-1 rounded">SAI</span>`;
                
                // V·ªõi c√¢u ƒë√∫ng sai th√¨ kh√¥ng hi·ªán ƒë√∫ng sai t·ªïng qu√°t
                if(item.type === 'true_false') badge = `<span class="bg-yellow-100 text-yellow-800 text-xs font-bold px-2 py-1 rounded">Xem l·ªùi gi·∫£i</span>`;

                let html = `
                <div class="bg-white border-l-4 ${borderColor} shadow rounded p-4 latex-content">
                    <div class="flex justify-between mb-2">
                        <span class="font-bold text-gray-700">C√¢u ${i+1}</span>
                        ${badge}
                    </div>
                    <div class="mb-3 text-gray-800">${formatText(item.question)}</div>
                    ${item.image ? `<img src="${item.image}" class="w-1/2 mb-3 rounded border">` : ''}
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 bg-gray-50 p-3 rounded text-sm">
                        <div>
                            <span class="font-semibold text-gray-600">C√¢u tr·∫£ l·ªùi c·ªßa b·∫°n:</span><br>
                            <span class="${item.isCorrect ? 'text-green-600' : 'text-red-600'} font-bold">${item.user || "Kh√¥ng tr·∫£ l·ªùi"}</span>
                        </div>
                        <div>
                            <span class="font-semibold text-gray-600">ƒê√°p √°n ch√≠nh x√°c:</span><br>
                            <span class="text-blue-600 font-bold">${item.correct || "(Xem l·ªùi gi·∫£i)"}</span>
                        </div>
                    </div>

                    <div class="mt-4 pt-3 border-t border-dashed border-gray-300">
                        <p class="font-bold text-gray-700 underline mb-1">L·ªùi gi·∫£i chi ti·∫øt:</p>
                        <div class="text-gray-800 bg-blue-50 p-3 rounded text-sm leading-relaxed">
                            ${item.solution ? formatText(item.solution) : "Ch∆∞a c√≥ l·ªùi gi·∫£i chi ti·∫øt cho c√¢u n√†y."}
                        </div>
                    </div>
                </div>`;
                container.innerHTML += html;
            });

            // Render l·∫°i c√¥ng th·ª©c to√°n trong ph·∫ßn l·ªùi gi·∫£i
            MathJax.typesetPromise();
        }

        // --- ADMIN HELPERS ---
        function toggleAdminPanel() {
            const sec = document.getElementById('admin-section');
            sec.classList.toggle('hidden');
        }

        function checkAdmin() {
            const pass = document.getElementById('admin-pass').value;
            if(pass === "anphuc01") {
                document.getElementById('login-form').classList.add('hidden');
                document.getElementById('upload-form').classList.remove('hidden');
            } else {
                alert("M·∫≠t kh·∫©u kh√¥ng ƒë√∫ng!");
            }
        }

        function uploadExam() {
            const fileInput = document.getElementById('file-input');
            const title = document.getElementById('exam-title').value;
            const duration = document.getElementById('exam-duration').value;
            
            if(fileInput.files.length === 0) return alert("Vui l√≤ng ch·ªçn file Word (.docx)!");
            if(!title) return alert("Vui l√≤ng nh·∫≠p t√™n ƒë·ªÅ thi!");

            const file = fileInput.files[0];
            const reader = new FileReader();
            
            const btn = document.getElementById('btn-upload');
            btn.innerText = "ƒêang t·∫£i l√™n v√† x·ª≠ l√Ω...";
            btn.disabled = true;
            btn.classList.add("opacity-50", "cursor-not-allowed");

            reader.onload = function(e) {
                const rawBase64 = e.target.result.split(',')[1];
                
                const payload = {
                    fileData: rawBase64,
                    fileName: file.name,
                    mimeType: file.type,
                    examTitle: title,
                    duration: duration
                };

                // D√πng mode 'no-cors' ƒë·ªÉ post file l·ªõn m√† kh√¥ng b·ªã l·ªói cross-origin ch·∫∑n
                // Tuy nhi√™n ta s·∫Ω kh√¥ng nh·∫≠n ƒë∆∞·ª£c JSON response success.
                // Ta s·∫Ω gi·∫£ ƒë·ªãnh th√†nh c√¥ng sau kho·∫£ng th·ªùi gian ch·ªù ho·∫∑c d√πng alert ƒë∆°n gi·∫£n.
                
                fetch(API_URL + "?action=uploadExam", {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                })
                .then(() => {
                    // Do no-cors n√™n kh√¥ng bi·∫øt ch√≠nh x√°c khi n√†o xong data return
                    // Nh∆∞ng request ƒë√£ g·ª≠i ƒëi.
                    alert("ƒê√£ g·ª≠i y√™u c·∫ßu t·∫°o ƒë·ªÅ! H·ªá th·ªëng ƒëang x·ª≠ l√Ω ng·∫ßm tr√™n Google Drive.\nVui l√≤ng ƒë·ª£i kho·∫£ng 10-20 gi√¢y r·ªìi b·∫•m 'L√†m m·ªõi danh s√°ch' ƒë·ªÉ th·∫•y ƒë·ªÅ thi.");
                    
                    document.getElementById('upload-status').innerText = "ƒê√£ g·ª≠i file. Vui l√≤ng ƒë·ª£i h·ªá th·ªëng x·ª≠ l√Ω...";
                    btn.innerText = "Upload & T·∫°o ƒë·ªÅ";
                    btn.disabled = false;
                    btn.classList.remove("opacity-50", "cursor-not-allowed");
                    
                    // Reset form
                    document.getElementById('exam-title').value = "";
                    document.getElementById('file-input').value = "";
                })
                .catch(err => {
                    console.error(err);
                    alert("C√≥ l·ªói x·∫£y ra khi upload.");
                    btn.disabled = false;
                });
            };
            reader.readAsDataURL(file);
        }

        function showSection(id) {
            if(id === 'home') {
                document.getElementById('home-section').classList.remove('hidden');
                document.getElementById('exam-section').classList.add('hidden');
                document.getElementById('result-section').classList.add('hidden');
                document.getElementById('admin-section').classList.add('hidden');
                fetchExams(); // T·∫£i l·∫°i danh s√°ch
            }
        }

        // T·ª± ƒë·ªông t·∫£i danh s√°ch khi m·ªü web
        fetchExams();
    </script>
</body>
</html>