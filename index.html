<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hệ Thống Thi Trực Tuyến - An Phúc</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>

    <script>
        MathJax = { tex: { inlineMath: [['$', '$'], ['\\(', '\\)']] }, svg: { fontCache: 'global' } };
    </script>
    <script id="MathJax-script" async
        src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <style>
        img { max-width: 100%; height: auto; margin: 10px auto; display: block; }
        .hidden { display: none; }
        .loading {
            border: 4px solid #ccc;
            border-top: 4px solid #1d4ed8;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {100% {transform: rotate(360deg)}}
    </style>
</head>

<body class="bg-gray-100 font-sans">

<header class="bg-blue-700 text-white p-4 shadow flex justify-between sticky top-0 z-50">
    <h1 class="font-bold text-lg">TRUNG TÂM AN PHÚC</h1>
    <div>
        <button onclick="showHome()" class="px-3 py-1 hover:bg-blue-600 rounded">Trang chủ</button>
        <button onclick="toggleAdmin()" class="px-3 py-1 hover:bg-blue-600 rounded">Admin</button>
    </div>
</header>

<div class="container mx-auto p-4 max-w-5xl">

<!-- ====================== ADMIN ===================== -->
<div id="admin-panel" class="hidden bg-white p-6 rounded shadow">
    <h2 class="font-bold text-xl text-blue-600 mb-4">Upload Đề Thi</h2>

    <div id="login-area">
        <input type="password" id="admin-pass" placeholder="Mật khẩu" class="border p-2 rounded">
        <button onclick="login()" class="bg-blue-600 text-white px-4 py-2 rounded">Đăng nhập</button>
    </div>

    <div id="upload-area" class="hidden">

        <div class="grid grid-cols-2 gap-4 mt-4">
            <input type="text" id="exam-title" placeholder="Tên đề thi" class="border p-2 rounded">
            <input type="number" id="exam-dur" value="90" placeholder="Thời gian" class="border p-2 rounded">
        </div>

        <input type="file" id="file-word" accept=".docx"
            class="mt-4 w-full file:rounded file:bg-blue-50 file:text-blue-700">

        <button onclick="processFile()" id="btn-up"
            class="mt-3 bg-green-600 text-white w-full py-2 rounded font-bold">Xử lý & Upload</button>

        <div id="status" class="text-center mt-2 text-blue-700 font-bold"></div>

        <pre id="preview-box" class="hidden bg-gray-100 border p-2 mt-2 text-xs h-40 overflow-y-scroll"></pre>
    </div>
</div>

<!-- ====================== DANH SÁCH ĐỀ ===================== -->
<div id="home-view">
    <h2 class="text-2xl font-bold mb-4">Danh sách đề thi</h2>
    <div id="exam-list" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
</div>
<!-- ====================== LÀM BÀI ===================== -->
<div id="exam-view" class="hidden">
    <div class="sticky top-16 bg-white p-3 shadow flex justify-between border-b border-blue-500">
        <h3 id="ex-title" class="font-bold text-blue-800"></h3>
        <div id="timer" class="font-mono text-xl text-red-600 font-bold"></div>
    </div>

    <div id="student-info" class="bg-white p-4 rounded shadow mt-4">
        <input id="std-name" placeholder="Họ tên" class="border p-2 rounded w-full mb-2">
        <input id="std-class" placeholder="Lớp" class="border p-2 rounded w-full mb-2">
        <button onclick="startTest()" class="bg-blue-600 text-white w-full py-2 rounded">Bắt đầu</button>
    </div>

    <div id="quiz-area" class="hidden space-y-6 mt-6"></div>

    <div id="submit-btn" class="hidden pb-10 text-center">
        <button onclick="submitTest()" class="bg-green-600 text-white px-10 py-2 rounded-full">Nộp bài</button>
    </div>
</div>

<!-- KẾT QUẢ -->
<div id="result-view" class="hidden bg-white p-6 rounded shadow text-center">
    <h2 class="text-xl font-bold">Kết Quả</h2>
    <div id="score-display" class="text-5xl text-blue-600 font-extrabold my-4"></div>
    <div id="detail-review" class="text-left space-y-4"></div>
</div>

</div>

<script>
/* ====================== CONFIG ===================== */
const API =
 "https://script.google.com/macros/s/AKfycbzLpV88SPYcjXgacYTHpkYzcRkajGRoFAG7SusDz0sY_UORAcOy2gPsdfkRgHrdaHzQ/exec";

let currExId = "", questions = [], timerInt;

/* ====================== ADMIN ===================== */
function toggleAdmin(){ document.getElementById('admin-panel').classList.toggle('hidden'); }
function login(){
    if(document.getElementById("admin-pass").value==="anphuc"){
        document.getElementById("login-area").classList.add("hidden");
        document.getElementById("upload-area").classList.remove("hidden");
    } else alert("Sai mật khẩu!");
}

/* ====================== LOAD EXAMS ===================== */
async function loadExams() {
    document.getElementById('exam-list').innerHTML = '<div class="loading mx-auto"></div>';

    try {
        let res = await fetch(API + "?action=getExams");
        let txt = await res.text();
        let data = JSON.parse(txt);

        let html = "";
        data.data.forEach(ex => {
            html += `
            <div class="bg-white p-4 shadow rounded border-l-4 border-blue-600">
                <h3 class="font-bold">${ex.title}</h3>
                <p>${ex.duration} phút</p>
                <button onclick="prepExam('${ex.id}', '${ex.title}', ${ex.duration})"
                    class="mt-2 bg-blue-100 text-blue-700 px-4 py-1 rounded">Thi ngay</button>
            </div>`;
        });
        document.getElementById("exam-list").innerHTML = html;
    }
    catch (e){
        document.getElementById("exam-list").innerHTML = "Lỗi tải đề!";
    }
}

/* ====================== CHUYỂN SANG LÀM BÀI ===================== */
function prepExam(id, title, dur){
    currExId = id;
    window.duration = dur * 60;

    document.getElementById("home-view").classList.add("hidden");
    document.getElementById("exam-view").classList.remove("hidden");

    document.getElementById("ex-title").innerText = title;
}

/* ====================== BẮT ĐẦU LÀM BÀI ===================== */
async function startTest(){
    if(!document.getElementById("std-name").value) return alert("Nhập tên!");

    document.getElementById("student-info").classList.add("hidden");
    document.getElementById("quiz-area").classList.remove("hidden");

    let res = await fetch(API + `?action=getQuestions&examId=${currExId}`);
    let txt = await res.text();
    let data = JSON.parse(txt);
    questions = data.data;

    renderQuestions();

    document.getElementById("submit-btn").classList.remove("hidden");

    startTimer();
    MathJax.typesetPromise();
}

function startTimer(){
    let t = window.duration;
    timerInt = setInterval(()=>{
        let m = Math.floor(t/60), s = t%60;
        document.getElementById("timer").innerText = `${m}:${s<10?'0'+s:s}`;
        if(t--<=0) submitTest();
    },1000);
}
/* ====================== RENDER CÂU HỎI ===================== */
function renderQuestions(){
    let html = "";

    questions.forEach((q, i)=>{
        html += `<div class="bg-white p-4 rounded shadow">`;

        html += `<div class="font-bold mb-2">Câu ${i+1}: ${q.question}</div>`;
        if(q.image) html += `<img src="${q.image}" class="border rounded mb-3">`;

        if(q.type === "choice") html += renderChoice(q, i);
        if(q.type === "truefalse") html += renderTF(q, i);
        if(q.type === "short") html += renderShort(q, i);

        html += `</div>`;
    });

    document.getElementById('quiz-area').innerHTML = html;
}

/* ====================== CHOICE ===================== */
function renderChoice(q, i){
    return `
        <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
            ${["A","B","C","D"].map(op => q["opt"+op] ? `
                <label class="border p-2 rounded flex hover:bg-blue-50 cursor-pointer">
                    <input type="radio" name="q${i}" value="${op}" class="mr-2 mt-1">
                    <span><b>${op}.</b> ${q["opt"+op]}</span>
                </label>` : "").join("")}
        </div>
    `;
}

/* ====================== TRUE/FALSE ===================== */
function renderTF(q, i){
    return `
        <div class="space-y-3">
            ${["A","B","C","D"].map(op => q["tf"+op] ? `
                <div class="border p-2 rounded">
                    <div class="mb-1"><b>${op.toLowerCase()})</b> ${q["tf"+op]}</div>
                    <label class="mr-4">
                        <input type="radio" name="q${i}_${op}" value="Đúng"> Đúng
                    </label>
                    <label>
                        <input type="radio" name="q${i}_${op}" value="Sai"> Sai
                    </label>
                </div>
            ` : "").join("")}
        </div>
    `;
}

/* ====================== SHORT ===================== */
function renderShort(q, i){
    return `
        <input type="text" name="q${i}_short" placeholder="Nhập câu trả lời"
            class="border p-2 rounded w-full">
    `;
}

/* ====================== NỘP BÀI ===================== */
function submitTest(){
    clearInterval(timerInt);

    let score = 0, detail = [];

    questions.forEach((q,i)=>{
        let userAns = null;

        if(q.type==="choice"){
            userAns = document.querySelector(`input[name="q${i}"]:checked`)?.value || "";
            if(userAns === q.correct) score++;
        }

        if(q.type==="truefalse"){
            userAns = {};
            ["A","B","C","D"].forEach(op=>{
                if(q["tf"+op]){
                    let v = document.querySelector(`input[name="q${i}_${op}"]:checked`)?.value || "";
                    userAns[op] = v;

                    let isCorrect = q.correct.includes(op);
                    if((v==="Đúng" && isCorrect) || (v==="Sai" && !isCorrect))
                        score++;
                }
            });
        }

        if(q.type==="short"){
            userAns = document.querySelector(`input[name="q${i}_short"]`)?.value.trim() || "";
            if(userAns == q.shortAns) score++;
        }

        detail.push({
            question: q.question,
            type: q.type,
            user: userAns,
            correct: q.correct || q.shortAns,
            solution: q.solution
        });
    });

    let payload = {
        action: "submitExam",
        student_name: document.getElementById("std-name").value,
        class_name: document.getElementById("std-class").value,
        exam_title: document.getElementById("ex-title").innerText,
        score: score,
        detail
    };

    fetch(API, {
        method:"POST",
        mode:"no-cors",
        body: JSON.stringify(payload)
    });

    document.getElementById("exam-view").classList.add("hidden");
    document.getElementById("result-view").classList.remove("hidden");

    document.getElementById("score-display").innerText = score;
}

/* ====================== PARSER WORD (3 PHẦN) ===================== */
function parseWord(html){
    const div = document.createElement("div");
    div.innerHTML = html;

    let lines = [...div.querySelectorAll("p")].map(p=>p.innerHTML.trim());

    let mode = "choice";
    let out = [];
    let current={};

    const isTF = t=>t.match(/^[abcd]\)/i);
    const hasUnderline = t=>t.includes("<u>");

    lines.forEach(ln=>{

        if(ln.includes("PHẦN II")) { mode="tf"; return; }
        if(ln.includes("PHẦN III")) { mode="short"; return; }

        /* --- PHẦN I --- */
        if(mode==="choice"){
            let m = ln.match(/^Câu\s*\d+\.*\s*(.*)/i);
            if(m){
                if(current.question) out.push(current);
                current = { type:"choice", question:m[1], optA:"",optB:"",optC:"",optD:"", correct:"", solution:"" };
                return;
            }
            if(ln.startsWith("A.")) current.optA = ln.slice(2).trim();
            if(ln.startsWith("B.")) current.optB = ln.slice(2).trim();
            if(ln.startsWith("C.")) current.optC = ln.slice(2).trim();
            if(ln.startsWith("D.")) current.optD = ln.slice(2).trim();

            if(ln.includes("Chọn")){
                let c = ln.match(/Chọn\s*([A-D])/i);
                if(c) current.correct = c[1].toUpperCase();
            }
        }

        /* --- PHẦN II --- */
        if(mode==="tf"){
            if(ln.startsWith("a)") || ln.startsWith("b)") || ln.startsWith("c)") || ln.startsWith("d)")){
                out.push({
                    type:"truefalse",
                    question: ln.replace(/^.\)/,"").trim(),
                    tfA:null, tfB:null, tfC:null, tfD:null,
                    correct:""
                });
                current = out[out.length-1];
                current.key = ln[0].toUpperCase();
            }

            if(ln.includes("Đúng") || hasUnderline(ln)){
                current.correct += current.key;
            }
        }

        /* --- PHẦN III --- */
        if(mode==="short"){
            if(ln.includes("Đáp số")){
                let num = ln.replace("Đáp số:","").replace(".","").trim();
                out.push({
                    type:"short",
                    question:"(Câu trả lời ngắn)",
                    shortAns:num
                });
            }
        }

    });

    return out;
}

/* ====================== UPLOAD ===================== */
function uploadData(qs){
    const payload = {
        action:"uploadParsedExam",
        examTitle: document.getElementById("exam-title").value,
        duration: document.getElementById("exam-dur").value,
        questions: qs
    };

    fetch(API,{method:"POST",mode:"no-cors",body:JSON.stringify(payload)})
    .then(()=>{ alert("Upload thành công!"); location.reload();});
}

/* ====================== INIT ===================== */
function showHome(){
    document.getElementById("home-view").classList.remove("hidden");
    document.getElementById("exam-view").classList.add("hidden");
    document.getElementById("result-view").classList.add("hidden");
}
loadExams();

</script>

</body>
</html>
